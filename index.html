<!DOCTYPE html>
<html>
	<head>
		<title>Hotstar video download</title>
		<link rel="shortcut icon" type="image/png" href="image/favicon.png">
		<style type="text/css">
  body {
   background: #333;
  }
  input {
   width: 50%;
   background: #333;
   color: #fff;
   border-width: 1px;
   border-style: inset;
  }
  a, label {
   color: #fff;
  }
  #showHideConsole{
	text-decoration: none;
  }
  .container {
   margin-top: 25%;
  }
  
		</style>
		
		<style>
   #responseText {
      width: 800px;
      height: 800px;
      background-color: black;
      color: white;
      overflow-x: auto;
      overflow-y: auto;
      max-width: 640px;
      max-height: 320px;
      font-size: 15px;
   }
</style>
		<link rel="stylesheet" href="css/mycss.css">
		<link rel="stylesheet" href="css/circular-progress-plugin.css">
		
		<script src="js/jquery-3.3.1.min.js"></script>
		<script type="text/javascript" src="js/pusher.min.js"></script>
		<script src="js/sweetalert2.all.min.js"></script>
		<script src="js/circular-progress-plugin.js"></script>
		<script src="js/myjs.js"></script>
		
		<script> 

    // Enable pusher logging - don't include this in production 

    Pusher.logToConsole = false; 
    var pusher = new Pusher(
       'a44d3a9ebac525080cf1', 
        { 
           cluster: 'ap2', 
           encrypted: true 
        }
    );
	
	function getMatches(string, regex, index) {
	  index || (index = 1); // default to the first capturing group
	  var matches = [];
	  var match;
	  while (match = regex.exec(string)) {
		matches.push(match[index]);
	  }
	  return matches;
	}
	
	function getMilliseconds(timeStr){
		var time = timeStr.split(/\.|:/);
		var hh = time[0];
		var mm = time[1];
		var ss = time[2];
		var milliSec = time[3];
		var total = (hh * 60 * 60 * 1000) + (mm * 60 * 1000) + (ss * 1000) + milliSec;
		return total;
	}
	
	function formatBytes(a,b){
		if(0 == a)
			return"0 Bytes";
		var c=1000/*Since base 10 values*/, d=b||2, e=["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"], f= Math.floor(Math.log(a)/Math.log(c)); 
		return parseFloat((a/Math.pow(c,f)).toFixed(d))+" "+e[f]
	}

    
    $.getJSON("https://api.ipify.org/?format=json", function(e) { 
       
       var ipAddr_userAgent = e.ip + "_" + navigator.userAgent;
       var isAlertShown = false;
       var isTotalDuration = true;
       var totalDurationInMilliSec = 0;
       var channel = pusher.subscribe('hotstar-video-download-v1'); 
       
       channel.bind(
          ipAddr_userAgent, 
          function(data) { 
             var msg=data.message;
             var data=msg['data'];
             var videoId=msg['videoId'];
			 
			 //added for testing
			 var durationRegex = /Duration: (\d{2}:\d{2}:\d{2}.\d{2})/g;
			 var timeRegex = /time=(\d{2}:\d{2}:\d{2}\.\d{2})/g;
			 var sizeRegex = /size=\s*(\d+)kB/g;
			 var timeMatches = getMatches(data, timeRegex, 1);
			 var sizeMatches = getMatches(data, sizeRegex, 1);
			 //console.log("Matched time data : "+JSON.stringify(timeMatches));
			 if(data.indexOf("Duration") > -1 ){
				var durationMatches = getMatches(data, durationRegex, 1);
				var totalDuration = durationMatches[0];
				totalDurationInMilliSec = getMilliseconds(totalDuration);
				//console.log("Total duration : "+totalDuration+" ms : "+totalDurationInMilliSec);
			 }else{
				/*
				console.log("----- Start of size time log -----");
					console.log(  "Duration : "+ timeMatches[i] + " ms : " + getMilliseconds(timeMatches[i]) + " %complete : "+ Math.round(((getMilliseconds(timeMatches[i])/totalDurationInMilliSec).toFixed(2) * 100 ))  );
					console.log(  "Size : "+formatBytes((sizeMatches[i] || 0)*1000));
				console.log("----- End of size time log -----");
				*/
				var matchSize = Math.max(timeMatches.length, sizeMatches.length);
				for(var i=0; i< matchSize; i++){
					cProgressOptions.percent = Math.round(((getMilliseconds(timeMatches[i])/totalDurationInMilliSec).toFixed(2) * 100 ));
					cProgressOptions.text = "Size : "+formatBytes((sizeMatches[i] || 0)*1000);
					$(".my-progress-bar").circularProgress(cProgressOptions);
				}
				
			 }
			 
             
             $('<br/><div style="font-size: 12px;">' + data +'<br/></div>').appendTo('#responseText');
             $('#responseText').stop(). animate({
                 scrollTop: $('#responseText')[0]. scrollHeight
             }, 800);
             
             var isVideoGenerationComplete = $('#responseText').text().indexOf('Video generation complete') > -1;
             
             if(isVideoGenerationComplete && !isAlertShown){
             	   
             	   isAlertShown = true;
             	   
             	   swal({
             	   	   type: 'success',
             	   	   title: "Video generation complete. Click the link to download video",
             	   	   showConfirmButton: false,
             	   	   timer: 2000, //dismiss after 2 seconds
             	   	});
					
					$('#videoGeneration').hide();
             	   	
             	   	var dLinkElement = '<br/><label>Video Link has been generated below</label><br/><br/><label><a href="downloadVideo.php?videoId='+videoId+'">Click Here</a> to download</label>';
             	   	
             	   $('<br/><br/>'+dLinkElement).appendTo('.container3');
             }
             
          }
       );

    });
    
     

</script>
	</head>
	<body>
		<center>
			<div class="container">
				<label>Enter Video URL</label>
				<br />

				<input id="url" type="text" />

				<br />

				<br />

				<button id="videoFormatGenerator">Fetch</button>
			</div>
			<br />

			<div class="container2">
				<label>Choose your video format :</label>
				<select class="videoFormats">
					<option class="defaultOption" disabled="disabled" selected="selected">-- select a video resolution --</option>
				</select>
				<br />

				<br />

				<button id="downloadVideo">Generate Video</button>
			</div>
			
			<div class="container3">
			
				<div id="videoGeneration">
				<div class="my-progress-bar"></div>
					<br/>
						<label id="waitLabel">Generating video please wait...</label>
					<br/>
				</div>
				
				<a id="showHideConsole" href="#">Show Console</a>
				<br/>
					<div id="responseText"></div>
				<br/>
			</div>
		</center>
		
	</body>
</html>