<!DOCTYPE html>
<html>

<head>
  <title>Pusher Test</title>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://js.pusher.com/4.3/pusher.min.js"></script>
  <script>

    // Enable pusher logging - don't include this in production
    Pusher.logToConsole = true;

    var pusher = new Pusher('a44d3a9ebac525080cf1', {
      cluster: 'ap2',
      forceTLS: true
    });
	var ipAddr_userAgent="";
	
	
	$.getJSON("https://api.ipify.org/?format=json", function(e) { 
		ipAddr_userAgent = e.ip + "_" + navigator.userAgent;
		var channel = pusher.subscribe('gdrive');
		channel.bind(ipAddr_userAgent, function(data) {
			//alert(data.message);
			//console.log("Auth Url : "+data.message);
    var txtBox = document.getElementById("txtBox");
    txtBox.value=data.message;
		});
	});
	
	function getAuthUrl(){
		$.ajax({ 
		   url: "uploadFileGDrive.php", 
		   type: "POST",
		   data: {
				action: "getAuthUrl"
			},
		})
		.done(function(response) {
			console.log(response);
			alert(response.data);
		})
		.fail(function(response) {
			console.error("Error occured in POST request completion");
		});
	}

  </script>


  
  <script>

  var REDIRECT="https://hotstar-test1.herokuapp.com";

  function authorize() {
    var txtBox = document.getElementById("txtBox");
    //alert("Text is "+txtBox.value);
    var authUrl=txtBox.value;
    var win = window.open(authUrl, "windowname1", 'width=800, height=600');
    var pollTimer = window.setInterval(function() { 
        try { 
            var url = win.document.URL; 
            console.log(url); 
            if (url.indexOf("code=") != -1) { 
               window.clearInterval(pollTimer); 
               //authCode = gup(url, 'code'); 
               //alert("authCode : "+authCode);
               //txtBox.value=authCode;
               var authCode=getQueryStringValue(url, "code");
               txtBox.value=authCode;
               win.close();
             } 
            } catch(e) { } 
     }, 1);
  }

  
  function getQueryStringValue(url, key) { 
     return decodeURIComponent(url.replace(new RegExp("^(?:.*[&\\?]" + encodeURIComponent(key).replace(/[\.\+\*]/g, "\\$&") + "(?:\\=([^&]*))?)?.*$", "i"), "$1")); 
  } 


 
  function uploadFile() {
    var txtBox = document.getElementById("txtBox");
    var authCode=txtBox.value;
    $.ajax({ 
		   url: "uploadFileGDrive.php", 
		   type: "POST",
		   data: {
				action: "uploadFile",
				authCode: authCode
			},
		})
		.done(function() {
			console.log("Auth code setup success");
   alert("Auth code setup success");
		})
		.fail(function() {
			console.error("Error occured in setting up Auth code");
   alert("Error occured in setting up Auth code");
		});
  }

  </script>


</head>
<body>
  
  <br/>
  <br/>
  <button onclick="getAuthUrl()">Get Auth Url</button>
  <br/><br/>

    <input type="text" id="txtBox" />
  <br/>
  <button onClick="authorize()">Authorize</button>
  <br/><br/><br/><br/>
  <button onClick="uploadFile()">Upload File</button>
  
</body>

</html>